generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductStatus {
  draft
  active
  archived
}

enum OrderStatus {
  created
  payment_pending
  paid
  fulfilled
  cancelled
}

enum PaymentStatus {
  pending
  authorized
  captured
  failed
  refunded
}

enum FulfillmentStatus {
  unfulfilled
  partially_fulfilled
  fulfilled
  cancelled
}

enum UserRole {
  customer
  admin
  ops
}

model User {
  id             String      @id @default(cuid())
  email          String      @unique
  passwordHash   String
  role           UserRole    @default(customer)
  firstName      String?
  lastName       String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  addresses      Address[]
  orders         Order[]
  carts          Cart[]
  auditLogs      AuditLog[]  @relation("AuditActor")
}

model Brand {
  id             String      @id @default(cuid())
  name           String
  slug           String      @unique
  description    String?
  products       Product[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model Product {
  id             String        @id @default(cuid())
  brandId        String
  handle         String        @unique
  title          String
  description    String?
  status         ProductStatus @default(draft)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  brand          Brand         @relation(fields: [brandId], references: [id])
  variants       Variant[]
  images         ProductImage[]
  collections    CollectionProduct[]
}

model Variant {
  id             String      @id @default(cuid())
  productId      String
  sku            String      @unique
  barcode        String?     @unique
  title          String
  price          Int
  compareAtPrice Int?
  cost           Int?
  inventoryQty   Int         @default(0)
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  product        Product     @relation(fields: [productId], references: [id])
  cartItems      CartItem[]
  orderItems     OrderItem[]

  @@index([productId])
}

model ProductImage {
  id             String   @id @default(cuid())
  productId      String
  url            String
  altText        String?
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  product        Product  @relation(fields: [productId], references: [id])

  @@index([productId, sortOrder])
}

model Collection {
  id             String              @id @default(cuid())
  title          String
  handle         String              @unique
  createdAt      DateTime            @default(now())
  products       CollectionProduct[]
}

model CollectionProduct {
  collectionId   String
  productId      String
  position       Int       @default(0)
  collection     Collection @relation(fields: [collectionId], references: [id])
  product        Product    @relation(fields: [productId], references: [id])

  @@id([collectionId, productId])
  @@index([productId])
}

model Address {
  id             String   @id @default(cuid())
  userId         String
  label          String?
  fullName       String
  line1          String
  line2          String?
  city           String
  province       String
  postalCode     String
  countryCode    String
  phone          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
  ordersShipping Order[]  @relation("ShippingAddress")
  ordersBilling  Order[]  @relation("BillingAddress")
}

model Cart {
  id             String     @id @default(cuid())
  userId         String?
  currency       String     @default("THB")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  user           User?      @relation(fields: [userId], references: [id])
  items          CartItem[]

  @@index([userId])
}

model CartItem {
  id             String   @id @default(cuid())
  cartId         String
  variantId      String
  qty            Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  cart           Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant        Variant  @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
}

model Order {
  id                String            @id @default(cuid())
  orderNumber       Int               @unique @default(autoincrement())
  userId            String?
  email             String
  status            OrderStatus       @default(created)
  paymentStatus     PaymentStatus     @default(pending)
  fulfillmentStatus FulfillmentStatus @default(unfulfilled)
  currency          String            @default("THB")
  subtotal          Int
  discountTotal     Int               @default(0)
  shippingTotal     Int               @default(0)
  taxTotal          Int               @default(0)
  grandTotal        Int
  shippingAddressId String
  billingAddressId  String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  user              User?             @relation(fields: [userId], references: [id])
  shippingAddress   Address           @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address           @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items             OrderItem[]
  payments          Payment[]
  events            OrderEvent[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  variantId      String
  skuSnapshot    String
  titleSnapshot  String
  unitPrice      Int
  qty            Int
  lineTotal      Int
  createdAt      DateTime @default(now())
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant        Variant  @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
}

model Payment {
  id                   String        @id @default(cuid())
  orderId              String
  provider             String
  providerPaymentId    String
  amount               Int
  currency             String
  status               PaymentStatus @default(pending)
  idempotencyKey       String        @unique
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  order                Order         @relation(fields: [orderId], references: [id])

  @@unique([provider, providerPaymentId])
  @@index([orderId])
}

model OrderEvent {
  id             String   @id @default(cuid())
  orderId        String
  fromStatus     OrderStatus?
  toStatus       OrderStatus
  reason         String?
  actorId        String?
  createdAt      DateTime @default(now())
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
}

model Coupon {
  id                String    @id @default(cuid())
  code              String    @unique
  description       String?
  discountType      String
  discountValue     Int
  startsAt          DateTime?
  endsAt            DateTime?
  usageLimit        Int?
  usageCount        Int       @default(0)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
}

model ShippingZone {
  id                String         @id @default(cuid())
  name              String
  countryCode       String
  province          String?
  rates             ShippingRate[]

  @@index([countryCode, province])
}

model ShippingRate {
  id                String      @id @default(cuid())
  zoneId            String
  name              String
  minSubtotal       Int?
  maxSubtotal       Int?
  price             Int
  etaMinDays        Int?
  etaMaxDays        Int?
  zone              ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId])
}

model AuditLog {
  id             String   @id @default(cuid())
  actorId        String?
  action         String
  targetType     String
  targetId       String
  meta           Json?
  createdAt      DateTime @default(now())
  actor          User?    @relation("AuditActor", fields: [actorId], references: [id])

  @@index([targetType, targetId])
  @@index([createdAt])
}

model WebhookEvent {
  id                String   @id @default(cuid())
  provider          String
  eventId           String
  eventType         String
  payload           Json
  processedAt       DateTime?
  createdAt         DateTime @default(now())

  @@unique([provider, eventId])
  @@index([createdAt])
}
